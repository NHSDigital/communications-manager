[% include './partials/Partial.Component.SetResponseDefaults.xml' %]
<Step>
    <Name>JavaScript.SetBackendCorrelationId</Name>
</Step>
<Step>
    <Name>AssignMessage.AddDefaultRequestPath</Name>
</Step>
{% if ENVIRONMENT_TYPE == 'sandbox' %}
    <Step>
        <Name>RaiseFault.408RequestTimeout</Name>
        <Condition>request.header.Prefer = "code=408"</Condition>
    </Step>
    <Step>
        <Name>RaiseFault.504GatewayTimeout</Name>
        <Condition>request.header.Prefer = "code=504"</Condition>
    </Step>
    <Step>
        <Name>RaiseFault.503ServiceUnavailable</Name>
        <Condition>request.header.Prefer = "code=503"</Condition>
    </Step>
    <Step>
        <Name>RaiseFault.500Generic</Name>
        <Condition>request.header.Prefer = "code=500"</Condition>
    </Step>
    <Step>
        <Name>RaiseFault.401Unauthorized</Name>
        <Condition>
            request.header.Authorization = "Bearer InvalidMockToken" or request.header.Prefer = "code=401"
        </Condition>
    </Step>
    <Step>
      <Name>RaiseFault.403Forbidden</Name>
      <Condition>
        request.header.Authorization = "Bearer ClientNotRecognised" or request.header.Prefer = "code=403"
      </Condition>
    </Step>
    <Step>
      <Name>RaiseFault.403ServiceBan</Name>
      <Condition>
        request.header.Prefer = "code=403.1"
      </Condition>
    </Step>
    <Step>
        <Name>RaiseFault.425RetryTooEarly</Name>
        <Condition>request.header.Prefer = "code=425"</Condition>
    </Step>
{% else %}
    <Step>
        <Name>OauthV2.VerifyAccessToken</Name>
    </Step>
    <Step>
        <Name>RaiseFault.403Forbidden</Name>
        <Condition>
            grant_type != "client_credentials"
        </Condition>
    </Step>
{% endif %}
[% include './partials/Partial.PreFlow.ContentNegotiation.xml' %]
{% if ENVIRONMENT_TYPE == 'sandbox' %}
    <Step>
        <Name>RaiseFault.429TooManyRequests</Name>
        <Condition>request.header.Prefer = "code=429"</Condition>
    </Step>
{% else %}
    <Step>
        <Name>RaiseFault.404NotFound</Name>
        <Condition>
            request.verb != "POST"
        </Condition>
    </Step>
    <Step>
        <Name>RaiseFault.404NotFound</Name>
        <Condition>
            proxy.pathsuffix != "/v1/message-batches" and proxy.pathsuffix != "/v1/messages"
        </Condition>
    </Step>
{% endif %}
